#!/usr/bin/env bash

TMP_NAME=`basename \`pwd\``
TMP_PATH=/tmp/nix-virtualenv-`pwd | md5sum | cut -f 1 -d " "`-$TMP_NAME
TMP_DEFAULT=$TMP_PATH/default.nix
PYTHON_VERSION=`basename $0 | rev | cut -c -2 | rev`
PACKAGES=""

while [[ $# > 0 ]]
do
key="$1"

case $key in
    -p)
    PACKAGES=$PACKAGES$'\n    '$2
    shift # past argument
    ;;
    *)
    ;;
esac

shift
done

if [ -e $TMP_DEFAULT ]; then 
  rm $TMP_DEFAULT
fi

mkdir -p $TMP_PATH
cat <<EOF > $TMP_DEFAULT
{ pythonVersion ? "27" }:

let
  pkgs = import <nixpkgs> {};
  pythonPackages = builtins.getAttr (
    if pythonVersion == "py"
        then "pypyPackages"
        else "python\${pythonVersion}Packages"
    ) pkgs;
  libPrefix = if pythonVersion == "py"
    then "pypy-c/site-packages"
    else "lib/\${python.libPrefix}/site-packages";
  binPrefix = if pythonVersion == "py"
    then "/pypy-c/bin"
    else "/bin";
  inherit (pythonPackages) python buildPythonPackage;
  custom_pip = pkgs.lib.overrideDerivation pythonPackages.pip (old: {
    prePatch = ''
      sed -i -e "/dest='root_path',/ { N; /\n.*metavar='dir',/ { N; /\n.*default=None/ { N; s@dest='root_path',\n.*metavar='dir',\n.*default=None@dest='root_path',\n            metavar='dir',\n            default=\"$TMP_PATH\"@ } } }" pip/commands/install.py
    '';
  });
  custom_buildout = pkgs.lib.overrideDerivation pythonPackages.zc_buildout221 (old: {
    postInstall = ''
      for script in \$out/bin/*; do
        wrapProgram \$script --set PYTHONPATH "\$PYTHONPATH"
      done
    '';
  });
  custom_setuptools = pkgs.lib.hiPrio (pkgs.lib.overrideDerivation pythonPackages.setuptools (old: {
    installPhase = old.installPhase + ''
      sed -i"" -e "s@.easy_install-wrapped@.easy_install-wrapped --prefix $TMP_PATH/\${python}/@" \$out/bin/easy_install
    '';
  }));
in pkgs.stdenv.mkDerivation {
  name = "nix-virtualenv-$TMP_NAME";
  src = ./.;
  buildInputs = with pkgs; with pkgs.python${PYTHON_VERSION}Packages; [$PACKAGES
    custom_setuptools
    custom_pip
    custom_buildout
  ];
  shellHook = ''
    PYTHONPREFIX="$TMP_PATH\${python}"
    PYTHONLIBPREFIX="\$PYTHONPREFIX/\${libPrefix}"
    PYTHONPATH="\$PYTHONLIBPREFIX:\$PYTHONPATH"
    PATH="\$PYTHONPREFIX\${binPrefix}:\$PATH"
    mkdir -p \$PYTHONLIBPREFIX
  '';
}
EOF


nix-shell $TMP_DEFAULT --argstr pythonVersion "$PYTHON_VERSION"
